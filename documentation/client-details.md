# Client Communication

This document describes the process to securely enrol a client into the management system.

## Security
Clients communicate over a TCP socket!

Installation script is embedded with server's public key so that client and server can perform key-exchange securely. 

Elliptical curve diffie hellman combined with AES-GCM will be used to encrypt data between server and client. On connection to the server, the client will issue a HELlO packet containing the client's public key and signed client ID and the server will respond with HELLOACK with its public key and the server-signed client-ID. The client will have a list of permitted server public keys so, if the sent key is not in the list and the signed client-ID cannot be verified, the connection will be closed.

The client ID signing shall be done using ECDSA. The signed data shall simply contain the client's ID. This will ensure the client and server are authenticated and data integrity is maintained.

HELLO and HELLOACK Packet structure as follows (66 byte header):
1. OP Code (1 byte)
2. Sender Public Key (33 bytes)
3. AES IV (16 bytes)
4. AES Tag (16 bytes)
5. AEM-GCM Encrypted data (Max 438 bytes - calculated from max TCP datagram size specified in [RFC 879](https://www.rfc-editor.org/rfc/rfc879#section-1))

All other packets follow the structure (33 byte header):
1. OP Code (1 byte)
3. AES IV (16 bytes)
4. AES Tag (16 bytes)
5. AEM-GCM Encrypted data (Max 503 bytes - calculated from max TCP datagram size specified in [RFC 879](https://www.rfc-editor.org/rfc/rfc879#section-1))

## Servers
Maintain two servers:
 - One server for the web dashboard - exposed over plain HTTP (Designed to be proxied!)
 - One server for client communication - TCP server using E2E

## OP Codes
There are two sets of OP codes defined in this protocol:
 - "Outer" OP Codes which are defined in the first byte of all packets and are unencrypted. These do not indicate the function of the call, just details about data transfer
 - "Inner" OP Codes which are contained in the encrypted portion of the message. These indicate details about the function of the message.

### Outer OP Codes
- `1` - `HELLO` - Initiate a communication with E2E keys
- `2` - `HELLOACK` - Response to `HELLO`, used so the other party can verify the connection
- `4` - `DATA` - General transfer of data (Non-chunked)
- `8` - `DATACHUNKED` - Data transfer that forms part of a chunked communications

### Inner OP Codes
- Registration of client
- 


## Client Enrolment

### 1. Generate Token
To enrol a client, a 16 digit token will be generated by the administrator from the dashboard. This serves a number of purposes:
 - Ensures clients can only join with permission from an administrator - they cannot be added without the token.
 - Identifies clients against specific labels/tags
 - Limiting how many clients can be enrolled or expiring the enrolment token

The token is generated using `crypto.randomBytes(8).toString("hex")`

### 2. Command Line Generated
The dashboard generates a script file that can be run on clients.

```sh
#!/bin/bash

# Verify script is running as root
if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

now=$(date +%Y-%m-%d_%H_%M_%S)

filename="/tmp/client_linux_$now.sh"
public_key="0f6a960103b08b03e79174277685162c7fbf089619c106fb62a533339dc22af2"
server_address="server.address"

# Download script from server
wget https://$server_address/clients/linux -o $filename --pinnedpubkey "sha256//$public_key"

# Make the script executable
chmod +x $filename

# -> Installation of thing here <-
```

### 3. Client Enrols with server

1. Attempts to connect to server using address.
2. Attempts to verify token against server.
3. Attempts to establish secure relationship with server.
   - d
4. **Only** after all of the above successful, then the client will install onto the client.

## Client 